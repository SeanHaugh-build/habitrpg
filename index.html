<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Habit Tracker</title>
    <style>
        :root {
            --primary-color: #007AFF;
            --background-color: #F2F2F7;
            --card-background: #FFFFFF;
            --border-radius: 12px;
            --spacing: 16px;
            --reward-color: #FFD700;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: var(--background-color);
            color: #1C1C1E;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: var(--spacing);
            margin-bottom: var(--spacing);
        }

        .habits-section {
            background-color: var(--card-background);
            border-radius: var(--border-radius);
            padding: var(--spacing);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .profile-section {
            background-color: var(--card-background);
            border-radius: var(--border-radius);
            padding: var(--spacing);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .avatar-container {
            width: 200px;
            height: 200px;
            margin: 0 auto 20px;
            position: relative;
            background-color: #F5F5F7;
            border-radius: var(--border-radius);
            overflow: hidden;
        }

        .avatar-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .streak-display {
            text-align: center;
            margin: 15px 0;
            padding: 10px;
            background-color: var(--background-color);
            border-radius: var(--border-radius);
        }

        .streak-value {
            font-size: 20px;
            font-weight: 700;
            color: #FF9500;
        }

        .stats-container {
            background-color: var(--background-color);
            border-radius: var(--border-radius);
            padding: 15px;
            margin: 20px 0;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background-color: var(--card-background);
            border-radius: 8px;
            font-size: 14px;
        }

        .stat-label {
            font-weight: 600;
            color: #6C6C70;
        }

        .stat-value {
            font-weight: 700;
            color: var(--primary-color);
        }

        .equipment-section {
            margin-top: 20px;
        }

        .equipment-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .equipment-slot {
            background-color: var(--background-color);
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .equipment-slot.empty {
            border: 2px dashed #C7C7CC;
        }

        .equipment-image {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .equipment-name {
            font-size: 12px;
            color: #6C6C70;
        }

        .equipment-stats {
            font-size: 11px;
            color: #34C759;
            margin-top: 2px;
        }

        .inventory-section {
            margin-top: 20px;
            background-color: var(--background-color);
            border-radius: var(--border-radius);
            padding: 15px;
        }

        .inventory-grid {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
        }

        .inventory-item {
            background-color: var(--card-background);
            border-radius: 8px;
            padding: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
            min-height: 60px;
            width: 100%;
        }

        .inventory-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .inventory-item.equipped {
            border-color: var(--primary-color);
            background-color: rgba(0, 122, 255, 0.05);
        }

        .inventory-item-image {
            font-size: 20px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--background-color);
            border-radius: 6px;
            flex-shrink: 0;
        }

        .inventory-item-details {
            flex: 1;
            min-width: 0; /* Allows text to wrap properly */
        }

        .inventory-item-name {
            font-weight: 600;
            margin-bottom: 2px;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .inventory-item-stats {
            font-size: 11px;
            color: #34C759;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .inventory-item-category {
            font-size: 10px;
            color: #8E8E93;
            margin-top: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .inventory-empty {
            text-align: center;
            padding: 20px;
            color: #8E8E93;
            font-style: italic;
            grid-column: 1 / -1;
        }

        .reward-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: var(--reward-color);
            color: #1C1C1E;
            padding: 15px 20px;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transform: translateX(120%);
            transition: transform 0.3s ease;
        }

        .reward-notification.show {
            transform: translateX(0);
        }

        h1 {
            font-size: 34px;
            font-weight: 700;
            margin: 24px 0;
            text-align: center;
        }

        .container {
            background-color: var(--card-background);
            border-radius: var(--border-radius);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            padding: var(--spacing);
            margin-bottom: 20px;
        }

        .date-navigation {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: var(--spacing);
            margin-bottom: 20px;
            padding: 10px;
            background-color: var(--card-background);
            border-radius: var(--border-radius);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        #currentWeek {
            font-size: 17px;
            font-weight: 600;
            color: #1C1C1E;
        }

        .add-habit {
            display: flex;
            flex-direction: column;
            gap: calc(var(--spacing) / 2);
            margin-bottom: 20px;
            padding: var(--spacing);
            background-color: var(--card-background);
            border-radius: var(--border-radius);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .add-habit-row {
            display: flex;
            gap: var(--spacing);
        }

        .habit-category {
            padding: 12px 16px;
            border: 1px solid #E5E5EA;
            border-radius: 8px;
            font-size: 17px;
            background-color: white;
            color: #1C1C1E;
            cursor: pointer;
        }

        .habit-category:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .stat-progress {
            height: 4px;
            background-color: #E5E5EA;
            border-radius: 2px;
            position: relative;
            margin-top: 4px;
        }

        .stat-progress-bar {
            height: 100%;
            background-color: var(--primary-color);
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        .stat-level {
            font-size: 12px;
            color: #8E8E93;
            margin-left: 4px;
        }

        input[type="text"] {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #E5E5EA;
            border-radius: 8px;
            font-size: 17px;
            transition: border-color 0.2s ease;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.1s ease, opacity 0.1s ease;
        }

        button:hover {
            opacity: 0.9;
        }

        button:active {
            transform: scale(0.98);
        }

        .habit-container {
            background-color: var(--card-background);
            border-radius: var(--border-radius);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        .habit-row {
            display: flex;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid #E5E5EA;
            transition: background-color 0.2s ease;
        }

        .habit-row:hover {
            background-color: #F9F9F9;
        }

        .habit-row.physical {
            border-left: 4px solid #FF3B30;
        }

        .habit-row.mental {
            border-left: 4px solid #5856D6;
        }

        .habit-row.endurance {
            border-left: 4px solid #34C759;
        }

        .habit-row.creative {
            border-left: 4px solid #FF9500;
        }

        .habit-name {
            flex: 1;
            font-size: 17px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: var(--spacing);
            position: relative;
        }

        .delete-btn {
            opacity: 0;
            background: none;
            color: #FF3B30;
            border: none;
            padding: 8px;
            font-size: 20px;
            font-weight: 300;
            cursor: pointer;
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            transition: opacity 0.2s ease;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .delete-btn:hover {
            background-color: rgba(255, 59, 48, 0.1);
        }

        .habit-row:hover .delete-btn {
            opacity: 1;
        }

        .checkbox-container {
            width: 80px;
            text-align: center;
        }

        .date-header {
            font-size: 14px;
            font-weight: 600;
            color: #6C6C70;
            text-align: center;
            padding: 8px;
        }

        .date-value {
            font-size: 12px;
            color: #8E8E93;
            margin-top: 4px;
        }

        input[type="checkbox"] {
            appearance: none;
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            border: 2px solid #E5E5EA;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        input[type="checkbox"]:checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        input[type="checkbox"]:checked::after {
            content: "✓";
            position: absolute;
            color: white;
            font-size: 16px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        input[type="checkbox"]:hover {
            border-color: var(--primary-color);
        }

        input[type="checkbox"]:disabled {
            background-color: #E5E5EA;
            border-color: #C7C7CC;
            cursor: not-allowed;
            opacity: 0.5;
        }

        input[type="checkbox"]:disabled:hover {
            border-color: #C7C7CC;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
                font-size: 14px;
            }

            .dashboard {
                display: flex;
                flex-direction: column;
                gap: 10px;
            }

            .habits-section {
                order: 1;
            }

            .profile-section {
                order: 2;
                display: flex;
                flex-direction: column;
            }

            /* Move habits section right after avatar */
            .avatar-container {
                order: 1;
            }

            .stats-container {
                order: 3;
            }

            .equipment-section {
                order: 4;
            }

            .inventory-section {
                order: 5;
            }

            .battle-section {
                order: 6;
            }

            /* Reduce spacing between sections */
            .profile-section > * {
                margin-top: 10px;
            }

            .avatar-container {
                margin-bottom: 10px;
            }

            .habit-row {
                padding: 10px;
                font-size: 14px;
            }

            .checkbox-container {
                width: 40px;
            }

            .date-header {
                font-size: 10px;
                padding: 4px;
            }

            .date-value {
                font-size: 9px;
            }

            .add-habit-row {
                flex-direction: column;
                gap: 8px;
            }

            .add-habit button {
                width: 100%;
            }

            .habit-category {
                width: 100%;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }

            .stat-item {
                padding: 6px;
                font-size: 12px;
            }

            .equipment-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .equipment-slot {
                min-height: 60px;
                padding: 8px;
            }

            .equipment-image {
                font-size: 20px;
            }

            .equipment-name {
                font-size: 10px;
            }

            .inventory-item {
                padding: 6px;
                min-height: 50px;
            }

            .inventory-item-image {
                width: 24px;
                height: 24px;
                font-size: 16px;
            }

            .inventory-item-name {
                font-size: 12px;
            }

            .inventory-item-stats,
            .inventory-item-category {
                font-size: 10px;
            }

            .battle-section {
                padding: 10px;
            }

            .battle-container {
                padding: 10px;
            }

            .battle-arena {
                height: 150px;
            }

            .monster-sprite {
                font-size: 48px;
            }

            .battle-controls {
                gap: 8px;
            }

            .battle-controls button {
                padding: 8px;
                font-size: 14px;
            }

            .badges-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 8px;
            }

            .badge {
                width: 40px;
                height: 40px;
                font-size: 20px;
            }

            h1 {
                font-size: 24px;
                margin: 16px 0;
            }

            .delete-btn {
                width: 28px;
                height: 28px;
                font-size: 16px;
            }

            input[type="checkbox"] {
                width: 20px;
                height: 20px;
            }

            input[type="checkbox"]:checked::after {
                font-size: 14px;
            }

            .streak-count {
                font-size: 10px;
                padding: 1px 4px;
            }

            /* Improve touch targets */
            button, 
            input[type="checkbox"],
            .inventory-item,
            .equipment-slot {
                cursor: pointer;
                -webkit-tap-highlight-color: transparent;
                touch-action: manipulation;
            }

            /* Add momentum scrolling */
            .battle-log,
            .inventory-grid {
                -webkit-overflow-scrolling: touch;
            }

            /* Prevent text selection */
            * {
                -webkit-touch-callout: none;
                -webkit-user-select: none;
                user-select: none;
            }

            /* Allow text selection in input fields */
            input[type="text"] {
                -webkit-user-select: text;
                user-select: text;
            }
        }

        .battle-section {
            margin-top: 20px;
            background-color: var(--background-color);
            border-radius: var(--border-radius);
            padding: 15px;
        }

        .battle-container {
            background-color: var(--card-background);
            border-radius: var(--border-radius);
            padding: 15px;
        }

        .battle-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .player-info, .monster-info {
            text-align: center;
        }

        .player-name, .monster-name {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .hp-bar {
            background-color: #E5E5EA;
            border-radius: 10px;
            height: 20px;
            position: relative;
            overflow: hidden;
        }

        .hp-bar-fill {
            background-color: #34C759;
            height: 100%;
            width: 100%;
            transition: width 0.3s ease;
        }

        .hp-text {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 12px;
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }

        .battle-arena {
            height: 200px;
            background-color: var(--background-color);
            border-radius: var(--border-radius);
            margin: 15px 0;
            position: relative;
            overflow: hidden;
        }

        .monster-sprite {
            font-size: 64px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .battle-log {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px;
            font-size: 14px;
            max-height: 80px;
            overflow-y: auto;
        }

        .battle-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .battle-controls button {
            flex: 1;
        }

        .badge-collection {
            margin-top: 15px;
        }

        .badges-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .badge {
            background-color: var(--background-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            position: relative;
        }

        .badge.locked {
            opacity: 0.3;
            filter: grayscale(1);
        }

        .badge:hover::after {
            content: attr(data-name);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
        }

        .streak-count {
            font-size: 12px;
            color: #FF9500;
            margin-left: 8px;
            padding: 2px 6px;
            background-color: rgba(255, 149, 0, 0.1);
            border-radius: 10px;
        }
        
        .equipment-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
    </style>
</head>
<body>
    <h1>Habit Tracker</h1>

    <div class="dashboard">
        <div class="habits-section">
            <div class="date-navigation">
                <button onclick="previousWeek()">← Previous</button>
                <span id="currentWeek"></span>
                <button onclick="nextWeek()">Next →</button>
            </div>

            <div class="add-habit">
                <div class="add-habit-row">
                    <input type="text" id="newHabit" placeholder="Add a new habit...">
                    <select id="habitCategory" class="habit-category">
                        <option value="">Select Category</option>
                        <option value="physical">Physical</option>
                        <option value="mental">Mental</option>
                        <option value="endurance">Endurance</option>
                        <option value="creative">Creative</option>
                    </select>
                    <button onclick="addHabit()">Add</button>
                </div>
            </div>

            <div id="habits" class="habit-container">
                <!-- Habits will be added here dynamically -->
            </div>
        </div>

        <div class="profile-section">
            <div class="avatar-container">
                <img id="avatar" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E%3Crect width='200' height='200' fill='%23F5F5F7'/%3E%3Ctext x='50%25' y='50%25' font-family='Arial' font-size='80' fill='%23C7C7CC' text-anchor='middle' dy='.3em'%3E⚔️%3C/text%3E%3C/svg%3E" alt="Avatar" class="avatar-image">
            </div>

            <div class="stats-container">
                <h3>Character Stats</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <span class="stat-label">HP</span>
                        <span id="hpStat" class="stat-value">100</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">MP</span>
                        <span id="mpStat" class="stat-value">50</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Strength</span>
                        <span id="strStat" class="stat-value">10</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Dexterity</span>
                        <span id="dexStat" class="stat-value">10</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Vitality</span>
                        <span id="vitStat" class="stat-value">10</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Magic</span>
                        <span id="magStat" class="stat-value">10</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Spirit</span>
                        <span id="sprStat" class="stat-value">10</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Luck</span>
                        <span id="lckStat" class="stat-value">10</span>
                    </div>
                </div>
            </div>

            <div class="equipment-section">
                <h3>Equipment</h3>
                <div class="equipment-grid">
                    <div id="weaponSlot" class="equipment-slot empty">
                        <div class="equipment-image">🗡️</div>
                        <div class="equipment-name">No weapon</div>
                    </div>
                    <div id="armorSlot" class="equipment-slot empty">
                        <div class="equipment-image">🛡️</div>
                        <div class="equipment-name">No armor</div>
                    </div>
                </div>
            </div>

            <div class="inventory-section">
                <h3>Inventory</h3>
                <div id="inventory" class="inventory-grid">
                    <!-- Inventory items will be added here dynamically -->
                </div>
            </div>

            <div class="battle-section">
                <h3>Battle Arena</h3>
                <div class="battle-container">
                    <div class="battle-stats">
                        <div class="player-info">
                            <div class="player-name">You</div>
                            <div class="hp-bar">
                                <div class="hp-bar-fill" id="playerHpBar"></div>
                                <span class="hp-text" id="playerHpText">100/100</span>
                            </div>
                        </div>
                        <div class="monster-info">
                            <div class="monster-name">???</div>
                            <div class="hp-bar">
                                <div class="hp-bar-fill" id="monsterHpBar"></div>
                                <span class="hp-text" id="monsterHpText">???/???</span>
                            </div>
                        </div>
                    </div>
                    <div class="battle-arena">
                        <div class="monster-sprite">👾</div>
                        <div class="battle-log"></div>
                    </div>
                    <div class="battle-controls">
                        <button id="attackBtn" onclick="performAttack()">Attack</button>
                        <button id="healBtn" onclick="performHeal()">Heal (MP: 10)</button>
                    </div>
                    <div class="badge-collection">
                        <h4>Monster Badges</h4>
                        <div id="badges" class="badges-grid">
                            <!-- Badges will be added here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="rewardNotification" class="reward-notification">
        🎉 New reward unlocked!
    </div>

    <script>
        let habits = JSON.parse(localStorage.getItem('habits')) || [];
        let habitStatus = JSON.parse(localStorage.getItem('habitStatus')) || {};
        let currentDate = new Date();

        // New variables for points and rewards system
        let points = JSON.parse(localStorage.getItem('points')) || 0;
        let inventory = JSON.parse(localStorage.getItem('inventory')) || [];
        let equipped = JSON.parse(localStorage.getItem('equipped')) || {};

        // Character stats and equipment
        let stats = JSON.parse(localStorage.getItem('stats')) || {
            hp: 100, // Base HP is always 100
            mp: 10,
            str: 10,
            dex: 10,
            vit: 10,
            mag: 10,
            spr: 10,
            lck: 10
        };

        // Available rewards with requirements and stats
        const rewards = [
            // Physical Category Items (Weapons)
            { 
                id: 'training_sword', 
                name: 'Training Sword', 
                image: '🗡️', 
                type: 'weapon',
                category: 'physical',
                streakRequired: 30,
                stats: { str: 5, dex: 2 }
            },
            { 
                id: 'warriors_blade', 
                name: 'Warrior\'s Blade', 
                image: '⚔️', 
                type: 'weapon',
                category: 'physical',
                streakRequired: 100,
                stats: { str: 15, dex: 8 }
            },
            { 
                id: 'legendary_sword', 
                name: 'Legendary Sword', 
                image: '🗡️', 
                type: 'weapon',
                category: 'physical',
                streakRequired: 365,
                stats: { str: 30, dex: 20 }
            },
            // Mental Category Items (Staves)
            { 
                id: 'apprentice_staff', 
                name: 'Apprentice Staff', 
                image: '🪄', 
                type: 'weapon',
                category: 'mental',
                streakRequired: 30,
                stats: { mag: 5, spr: 2 }
            },
            { 
                id: 'wizards_staff', 
                name: 'Wizard\'s Staff', 
                image: '🎭', 
                type: 'weapon',
                category: 'mental',
                streakRequired: 100,
                stats: { mag: 15, spr: 8 }
            },
            { 
                id: 'archmage_staff', 
                name: 'Archmage Staff', 
                image: '🔮', 
                type: 'weapon',
                category: 'mental',
                streakRequired: 365,
                stats: { mag: 30, spr: 20 }
            },
            // Endurance Category Items (Armor)
            { 
                id: 'training_armor', 
                name: 'Training Armor', 
                image: '🛡️', 
                type: 'armor',
                category: 'endurance',
                streakRequired: 30,
                stats: { hp: 30, vit: 5 }
            },
            { 
                id: 'knights_armor', 
                name: 'Knight\'s Armor', 
                image: '🛡️', 
                type: 'armor',
                category: 'endurance',
                streakRequired: 100,
                stats: { hp: 100, vit: 15 }
            },
            { 
                id: 'divine_armor', 
                name: 'Divine Armor', 
                image: '🛡️', 
                type: 'armor',
                category: 'endurance',
                streakRequired: 365,
                stats: { hp: 300, vit: 30 }
            },
            // Creative Category Items (Accessories)
            { 
                id: 'inspiration_charm', 
                name: 'Inspiration Charm', 
                image: '✨', 
                type: 'accessory',
                category: 'creative',
                streakRequired: 30,
                stats: { mp: 30, mag: 5 }
            },
            { 
                id: 'muse_pendant', 
                name: 'Muse\'s Pendant', 
                image: '🎨', 
                type: 'accessory',
                category: 'creative',
                streakRequired: 100,
                stats: { mp: 100, mag: 15 }
            },
            { 
                id: 'creators_crown', 
                name: 'Creator\'s Crown', 
                image: '👑', 
                type: 'accessory',
                category: 'creative',
                streakRequired: 365,
                stats: { mp: 300, mag: 30 }
            }
        ];

        // Get formatted date string
        const formatDate = (date) => {
            return date.toISOString().split('T')[0];
        };

        const formatDisplayDate = (dateStr) => {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        };

        // Get dates for the current week
        function getWeekDates(date) {
            const sunday = new Date(date);
            sunday.setDate(date.getDate() - date.getDay());
            
            const weekDates = [];
            for (let i = 0; i < 7; i++) {
                const day = new Date(sunday);
                day.setDate(sunday.getDate() + i);
                weekDates.push(formatDate(day));
            }
            return weekDates;
        }

        // Navigation functions
        function previousWeek() {
            currentDate.setDate(currentDate.getDate() - 7);
            renderHabits();
        }

        function nextWeek() {
            currentDate.setDate(currentDate.getDate() + 7);
            renderHabits();
        }

        // Check for unlocked rewards
        function checkForRewards(habit) {
            const streak = calculateStreak(habit);
            const category = habit.category;
            
            // Find all rewards for this category that we don't have yet
            const eligibleRewards = rewards.filter(reward => 
                reward.category === category && 
                streak >= reward.streakRequired && 
                !inventory.some(item => item.id === reward.id)
            );

            if (eligibleRewards.length > 0) {
                eligibleRewards.forEach(reward => {
                    // Double check the reward isn't already in inventory before adding
                    if (!inventory.some(item => item.id === reward.id)) {
                        inventory.push(reward);
                        const notification = document.getElementById('rewardNotification');
                        notification.textContent = `🎉 You earned ${reward.name} for ${streak} days of ${category} habits!`;
                        notification.classList.add('show');
                        setTimeout(() => {
                            notification.classList.remove('show');
                        }, 3000);
                    }
                });

                // Save inventory after adding all rewards
                localStorage.setItem('inventory', JSON.stringify(inventory));
                renderInventory();
            }
        }

        // Calculate streak for a habit
        function calculateStreak(habit) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            let streak = 0;
            let currentDate = new Date(today);

            while (true) {
                const dateStr = formatDate(currentDate);
                if (!habitStatus[dateStr] || !habitStatus[dateStr][habit.name]) {
                    break;
                }
                streak++;
                currentDate.setDate(currentDate.getDate() - 1);
            }

            return streak;
        }

        // Update habit status
        function updateHabitStatus(habit, date, isChecked) {
            if (!habitStatus[date]) {
                habitStatus[date] = {};
            }
            
            // Only update stats if habit is being checked
            if (isChecked && !habitStatus[date][habit.name]) {
                // Find habit category and apply stat gains
                if (habit.category) {
                    const category = habitCategories[habit.category];
                    if (category) {
                        Object.entries(category.expGain).forEach(([stat, gain]) => {
                            addStatExp(stat, gain);
                        });
                    }
                }
            }
            
            habitStatus[date][habit.name] = isChecked;
            localStorage.setItem('habitStatus', JSON.stringify(habitStatus));

            // Check for rewards after updating status
            checkForRewards(habit);
        }

        // Render habits with streak display
        function renderHabits() {
            const habitsContainer = document.getElementById('habits');
            habitsContainer.innerHTML = '';
            
            const weekDates = getWeekDates(currentDate);
            const weekRange = `${formatDisplayDate(weekDates[0])} - ${formatDisplayDate(weekDates[6])}`;
            document.getElementById('currentWeek').textContent = weekRange;

            // Create header row with dates
            const headerRow = document.createElement('div');
            headerRow.className = 'habit-row';
            headerRow.innerHTML = '<div class="habit-name">Habit</div>';
            
            const daysOfWeek = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            weekDates.forEach((date, index) => {
                const dateHeader = document.createElement('div');
                dateHeader.className = 'checkbox-container';
                dateHeader.innerHTML = `
                    <div class="date-header">
                        ${daysOfWeek[index]}
                        <div class="date-value">${formatDisplayDate(date)}</div>
                    </div>
                `;
                headerRow.appendChild(dateHeader);
            });
            habitsContainer.appendChild(headerRow);

            // Create habit rows
            habits.forEach((habit, index) => {
                const streak = calculateStreak(habit);
                const habitRow = document.createElement('div');
                habitRow.className = `habit-row${habit.category ? ' ' + habit.category : ''}`;

                const habitName = document.createElement('div');
                habitName.className = 'habit-name';
                habitName.innerHTML = `
                    ${habit.name || habit}
                    <span class="streak-count">🔥 ${streak}</span>
                `;

                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = '×';
                deleteBtn.className = 'delete-btn';
                deleteBtn.onclick = () => deleteHabit(index);
                habitName.appendChild(deleteBtn);

                habitRow.appendChild(habitName);

                // Add checkboxes for each day of the week
                weekDates.forEach(date => {
                    const checkboxContainer = document.createElement('div');
                    checkboxContainer.className = 'checkbox-container';

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.checked = habitStatus[date]?.[habit.name] || false;
                    
                    // Check if date is within allowed range (today and previous 2 days)
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    const checkDate = new Date(date);
                    const daysDifference = Math.floor((today - checkDate) / (1000 * 60 * 60 * 24));
                    
                    if (checkDate > today || daysDifference > 2) {
                        checkbox.disabled = true;
                        checkbox.title = checkDate > today ? 
                            "Cannot check off future habits" : 
                            "Can only check off habits from the past 2 days";
                    } else {
                        checkbox.addEventListener('change', () => {
                            updateHabitStatus(habit, date, checkbox.checked);
                        });
                    }

                    checkboxContainer.appendChild(checkbox);
                    habitRow.appendChild(checkboxContainer);
                });

                habitsContainer.appendChild(habitRow);
            });
        }

        // Add new habit
        function addHabit() {
            const input = document.getElementById('newHabit');
            const category = document.getElementById('habitCategory');
            const habitName = input.value.trim();
            const habitCategory = category.value;

            if (habitName && habitCategory && !habits.some(h => h.name === habitName)) {
                habits.push({
                    name: habitName,
                    category: habitCategory
                });
                localStorage.setItem('habits', JSON.stringify(habits));
                input.value = '';
                category.value = '';
                renderHabits();
            } else if (!habitCategory) {
                alert('Please select a category for your habit');
            }
        }

        // Delete habit
        function deleteHabit(index) {
            habits.splice(index, 1);
            localStorage.setItem('habits', JSON.stringify(habits));
            renderHabits();
        }

        // Update points display
        function updatePointsDisplay() {
            document.getElementById('pointsValue').textContent = points;
            localStorage.setItem('points', JSON.stringify(points));
        }

        // Show reward notification
        function showRewardNotification() {
            const notification = document.getElementById('rewardNotification');
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Add points for completing a habit
        function addPoints(amount) {
            points += amount;
            updatePointsDisplay();
            
            // Check if any rewards are unlocked
            rewards.forEach(reward => {
                if (points >= reward.cost && !inventory.some(item => item.id === reward.id)) {
                    inventory.push(reward);
                    localStorage.setItem('inventory', JSON.stringify(inventory));
                    showRewardNotification();
                    renderInventory();
                }
            });
        }

        // Update equipment display to include accessories
        function updateEquipmentDisplay() {
            const weaponSlot = document.getElementById('weaponSlot');
            const armorSlot = document.getElementById('armorSlot');
            const accessorySlot = document.createElement('div');
            accessorySlot.id = 'accessorySlot';
            accessorySlot.className = 'equipment-slot empty';
            
            // Add accessory slot if it doesn't exist
            if (!document.getElementById('accessorySlot')) {
                document.querySelector('.equipment-grid').appendChild(accessorySlot);
            }
            
            // Update weapon slot
            const equippedWeapon = inventory.find(item => item.id === equipped.weapon);
            if (equippedWeapon) {
                weaponSlot.className = 'equipment-slot';
                const statsText = Object.entries(equippedWeapon.stats)
                    .map(([stat, value]) => `+${value} ${stat.toUpperCase()}`)
                    .join(', ');
                weaponSlot.innerHTML = `
                    <div class="equipment-image">${equippedWeapon.image}</div>
                    <div class="equipment-name">${equippedWeapon.name}</div>
                    <div class="equipment-stats">${statsText}</div>
                `;
            } else {
                weaponSlot.className = 'equipment-slot empty';
                weaponSlot.innerHTML = `
                    <div class="equipment-image">🗡️</div>
                    <div class="equipment-name">No weapon</div>
                `;
            }
            
            // Update armor slot
            const equippedArmor = inventory.find(item => item.id === equipped.armor);
            if (equippedArmor) {
                armorSlot.className = 'equipment-slot';
                const statsText = Object.entries(equippedArmor.stats)
                    .map(([stat, value]) => `+${value} ${stat.toUpperCase()}`)
                    .join(', ');
                armorSlot.innerHTML = `
                    <div class="equipment-image">${equippedArmor.image}</div>
                    <div class="equipment-name">${equippedArmor.name}</div>
                    <div class="equipment-stats">${statsText}</div>
                `;
            } else {
                armorSlot.className = 'equipment-slot empty';
                armorSlot.innerHTML = `
                    <div class="equipment-image">🛡️</div>
                    <div class="equipment-name">No armor</div>
                `;
            }

            // Update accessory slot
            const equippedAccessory = inventory.find(item => item.id === equipped.accessory);
            if (equippedAccessory) {
                accessorySlot.className = 'equipment-slot';
                const statsText = Object.entries(equippedAccessory.stats)
                    .map(([stat, value]) => `+${value} ${stat.toUpperCase()}`)
                    .join(', ');
                accessorySlot.innerHTML = `
                    <div class="equipment-image">${equippedAccessory.image}</div>
                    <div class="equipment-name">${equippedAccessory.name}</div>
                    <div class="equipment-stats">${statsText}</div>
                `;
            } else {
                accessorySlot.className = 'equipment-slot empty';
                accessorySlot.innerHTML = `
                    <div class="equipment-image">✨</div>
                    <div class="equipment-name">No accessory</div>
                `;
            }

            // Update total stats after equipment changes
            updateStatsDisplay();
        }

        // Render inventory with sorting and filtering
        function renderInventory() {
            const inventoryContainer = document.getElementById('inventory');
            inventoryContainer.innerHTML = '';

            if (inventory.length === 0) {
                const emptyMessage = document.createElement('div');
                emptyMessage.className = 'inventory-empty';
                emptyMessage.textContent = 'Complete habits to earn equipment!';
                inventoryContainer.appendChild(emptyMessage);
                return;
            }

            // Sort inventory by category and type
            const sortedInventory = [...inventory].sort((a, b) => {
                if (a.category !== b.category) {
                    return a.category.localeCompare(b.category);
                }
                return a.type.localeCompare(b.type);
            });

            sortedInventory.forEach(item => {
                const itemElement = document.createElement('div');
                itemElement.className = `inventory-item${equipped[item.type] === item.id ? ' equipped' : ''}`;
                
                const statsText = Object.entries(item.stats)
                    .map(([stat, value]) => `+${value} ${stat.toUpperCase()}`)
                    .join(', ');

                itemElement.innerHTML = `
                    <div class="inventory-item-image">${item.image}</div>
                    <div class="inventory-item-details">
                        <div class="inventory-item-name">${item.name}</div>
                        <div class="inventory-item-stats">${statsText}</div>
                        <div class="inventory-item-category">
                            ${item.category.charAt(0).toUpperCase() + item.category.slice(1)} ${item.type.charAt(0).toUpperCase() + item.type.slice(1)}
                        </div>
                    </div>
                `;
                
                if (equipped[item.type] === item.id) {
                    itemElement.title = 'Click to unequip';
                } else {
                    itemElement.title = 'Click to equip';
                }

                itemElement.onclick = () => equipItem(item);
                inventoryContainer.appendChild(itemElement);
            });
        }

        // Equip/unequip item with validation
        function equipItem(item) {
            if (!item || !item.type) return;

            if (equipped[item.type] === item.id) {
                delete equipped[item.type];
            } else {
                equipped[item.type] = item.id;
            }

            localStorage.setItem('equipped', JSON.stringify(equipped));
            updateEquipmentDisplay();
            renderInventory();
            updateAvatar();
        }

        // Update avatar with equipped items
        function updateAvatar() {
            const avatar = document.getElementById('avatar');
            let avatarHtml = '👤'; // Base avatar
            
            // Add equipped items
            Object.values(equipped).forEach(itemId => {
                const item = inventory.find(i => i.id === itemId);
                if (item) {
                    avatarHtml += item.image;
                }
            });
            
            // Update avatar SVG
            avatar.src = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E%3Crect width='200' height='200' fill='%23F5F5F7'/%3E%3Ctext x='50%25' y='50%25' font-family='Arial' font-size='40' fill='%23000000' text-anchor='middle' dy='.3em'%3E${avatarHtml}%3C/text%3E%3C/svg%3E`;
        }

        // Update stats display
        function updateStatsDisplay() {
            const totalStats = calculateTotalStats();
            const statNames = ['hp', 'mp', 'str', 'dex', 'vit', 'mag', 'spr', 'lck'];
            
            statNames.forEach(stat => {
                const statElement = document.getElementById(`${stat}Stat`);
                if (!statElement) return;

                const statValue = Math.floor(totalStats[stat]);
                const statLevel = calculateStatLevel(stat);
                const progress = calculateStatProgress(stat);
                
                statElement.innerHTML = `
                    ${statValue}
                    <span class="stat-level">Lv.${statLevel}</span>
                    <div class="stat-progress">
                        <div class="stat-progress-bar" style="width: ${progress}%"></div>
                    </div>
                `;
            });

            // Don't save totalStats to localStorage, only save base stats
            localStorage.setItem('stats', JSON.stringify(stats));
        }

        // Calculate base stats plus equipment bonuses
        function calculateTotalStats() {
            // Start with base stats
            const baseStats = {
                hp: 100, // Base HP is always 100
                mp: 10 + (stats.mag * 2),
                str: Math.floor(stats.str),
                dex: Math.floor(stats.dex),
                vit: Math.floor(stats.vit),
                mag: Math.floor(stats.mag),
                spr: Math.floor(stats.spr),
                lck: Math.floor(stats.lck)
            };
            
            // Add vitality bonus to HP after base HP is set
            baseStats.hp += (baseStats.vit * 5); // Vitality bonus
            
            // Add equipment bonuses
            Object.values(equipped).forEach(itemId => {
                const item = inventory.find(i => i.id === itemId);
                if (item && item.stats) {
                    Object.entries(item.stats).forEach(([stat, value]) => {
                        if (baseStats.hasOwnProperty(stat)) {
                            if (stat === 'hp') {
                                baseStats[stat] += Math.floor(value); // Add HP bonus directly
                            } else {
                                baseStats[stat] += Math.floor(value);
                            }
                        }
                    });
                }
            });

            return baseStats;
        }

        // Calculate stat level based on experience
        function calculateStatLevel(stat) {
            return Math.floor(Math.sqrt(statExp[stat] / 100)) + 1;
        }

        // Calculate progress to next level (0-100)
        function calculateStatProgress(stat) {
            const currentLevel = calculateStatLevel(stat);
            const expForCurrentLevel = (currentLevel - 1) * (currentLevel - 1) * 100;
            const expForNextLevel = currentLevel * currentLevel * 100;
            const progress = ((statExp[stat] - expForCurrentLevel) / (expForNextLevel - expForCurrentLevel)) * 100;
            return Math.min(Math.max(progress, 0), 100);
        }

        // Add experience to stats
        function addStatExp(stat, amount) {
            statExp[stat] += amount;
            localStorage.setItem('statExp', JSON.stringify(statExp));
            updateStatsDisplay();
        }

        // Define habit categories and their stat effects
        const habitCategories = {
            physical: {
                stats: ['str', 'dex'],
                expGain: {
                    str: 10,
                    dex: 8
                }
            },
            mental: {
                stats: ['mag', 'spr'],
                expGain: {
                    mag: 10,
                    spr: 8
                }
            },
            endurance: {
                stats: ['hp', 'vit'],
                expGain: {
                    hp: 10,
                    vit: 8
                }
            },
            creative: {
                stats: ['mp', 'mag'],
                expGain: {
                    mp: 10,
                    mag: 8
                }
            }
        };

        // Initialize stat experience and levels
        let statExp = JSON.parse(localStorage.getItem('statExp')) || {
            hp: 0, mp: 0, str: 0, dex: 0, vit: 0, mag: 0, spr: 0, lck: 0
        };

        // Default starter equipment
        const starterEquipment = [
            {
                id: 'wooden_stick',
                name: 'Stale Baguette',
                image: '🥖',
                type: 'weapon',
                category: 'physical',
                streakRequired: 0,
                stats: { str: 2, dex: 1 }
            },
            {
                id: 'plastic_shield',
                name: 'Plastic Shield',
                image: '🛡️',
                type: 'armor',
                category: 'endurance',
                streakRequired: 0,
                stats: { hp: 10, vit: 1 }
            }
        ];

        // Initialize everything
        function initializeGame() {
            // Clear any existing intervals to prevent multiple initializations
            if (window.gameInitialized) return;
            window.gameInitialized = true;

            // Load saved data first
            habits = JSON.parse(localStorage.getItem('habits')) || [];
            
            // Add default habits if there are no habits yet
            if (habits.length === 0) {
                const defaultHabits = [
                    { name: "Go to the gym", category: "physical" },
                    { name: "10000 steps", category: "endurance" },
                    { name: "Eat healthy", category: "physical" },
                    { name: "Journal", category: "creative" },
                    { name: "Meditate", category: "mental" },
                    { name: "Practice instrument", category: "creative" }
                ];
                habits = defaultHabits;
                localStorage.setItem('habits', JSON.stringify(habits));
            }

            habitStatus = JSON.parse(localStorage.getItem('habitStatus')) || {};
            inventory = JSON.parse(localStorage.getItem('inventory')) || [...starterEquipment];
            equipped = JSON.parse(localStorage.getItem('equipped')) || {};
            
            // Initialize base stats (not total stats)
            stats = JSON.parse(localStorage.getItem('stats')) || {
                hp: 100,  // Base HP is always 100
                mp: 10,
                str: 10,
                dex: 10,
                vit: 10,
                mag: 10,
                spr: 10,
                lck: 10
            };

            // Ensure stats are numbers and HP is always 100
            Object.keys(stats).forEach(key => {
                if (key === 'hp') {
                    stats[key] = 100; // Always set base HP to 100
                } else {
                    stats[key] = Number(stats[key]) || (key === 'mp' ? 10 : 10);
                }
            });

            statExp = JSON.parse(localStorage.getItem('statExp')) || {
                hp: 0, mp: 0, str: 0, dex: 0, vit: 0, mag: 0, spr: 0, lck: 0
            };
            badges = JSON.parse(localStorage.getItem('badges')) || [];

            // Then update all UI elements
            updateStatsDisplay();
            updateEquipmentDisplay();
            renderInventory();
            updateAvatar();
            renderHabits();
            updateBadges();
            initializeBattle();

            // Save initial state
            localStorage.setItem('habits', JSON.stringify(habits));
            localStorage.setItem('habitStatus', JSON.stringify(habitStatus));
            localStorage.setItem('inventory', JSON.stringify(inventory));
            localStorage.setItem('stats', JSON.stringify(stats));
            localStorage.setItem('statExp', JSON.stringify(statExp));
        }

        // Remove the extra stats display refresh on load
        window.addEventListener('load', initializeGame);

        // Add DOMContentLoaded event listener to ensure habits are rendered
        document.addEventListener('DOMContentLoaded', () => {
            // Load habits from localStorage
            habits = JSON.parse(localStorage.getItem('habits')) || [];
            habitStatus = JSON.parse(localStorage.getItem('habitStatus')) || {};
            // Render habits immediately
            renderHabits();
        });

        // Allow adding habit with Enter key
        document.getElementById('newHabit').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                addHabit();
            }
        });

        // Monster definitions
        const monsters = [
            {
                id: 1,
                name: "Training Dummy",
                sprite: "🎯",
                hp: 50,
                attack: 5,
                defense: 2,
                badge: "🎯",
                badgeName: "Beginner's Badge",
                expReward: 100
            },
            {
                id: 2,
                name: "Slime",
                sprite: "🫧",
                hp: 100,
                attack: 8,
                defense: 5,
                badge: "🫧",
                badgeName: "Slime Conqueror",
                expReward: 200
            },
            {
                id: 3,
                name: "Forest Wolf",
                sprite: "🐺",
                hp: 200,
                attack: 15,
                defense: 8,
                badge: "🐺",
                badgeName: "Wolf Hunter",
                expReward: 400
            },
            {
                id: 4,
                name: "Dark Knight",
                sprite: "⚔️",
                hp: 500,
                attack: 25,
                defense: 15,
                badge: "⚔️",
                badgeName: "Knight Slayer",
                expReward: 800
            },
            {
                id: 5,
                name: "Ancient Dragon",
                sprite: "🐉",
                hp: 1000,
                attack: 40,
                defense: 25,
                badge: "🐉",
                badgeName: "Dragon Slayer",
                expReward: 1500
            }
        ];

        // Battle state
        let currentBattle = {
            active: false,
            monster: null,
            monsterCurrentHp: 0,
            playerCurrentMp: 0,
            turn: 0
        };

        // Player badges
        let badges = JSON.parse(localStorage.getItem('badges')) || [];

        // Initialize battle
        function initializeBattle() {
            if (currentBattle.active) return;
            
            // Find next undefeated monster
            const nextMonster = monsters.find(m => !badges.includes(m.id));
            if (!nextMonster) {
                updateBattleLog("You've defeated all monsters!");
                return;
            }

            const totalStats = calculateTotalStats();
            
            // Initialize battle state
            currentBattle = {
                active: true,
                monster: nextMonster,
                monsterCurrentHp: nextMonster.hp,
                turn: 0
            };

            // Ensure player stats are properly initialized and capped at max values
            if (isNaN(stats.hp) || stats.hp <= 0) stats.hp = totalStats.hp;
            if (isNaN(stats.mp) || stats.mp <= 0) stats.mp = totalStats.mp;
            
            stats.hp = Math.min(Math.floor(stats.hp), totalStats.hp);
            stats.mp = Math.min(Math.floor(stats.mp), totalStats.mp);
            
            localStorage.setItem('stats', JSON.stringify(stats));
            updateBattleUI();
        }

        // Update battle UI with proper number handling
        function updateBattleUI() {
            const monster = currentBattle.monster;
            if (!monster) return;

            const totalStats = calculateTotalStats();
            
            // Ensure stats are valid numbers
            if (isNaN(stats.hp)) stats.hp = totalStats.hp;
            if (isNaN(stats.mp)) stats.mp = totalStats.mp;

            // Update monster info
            document.querySelector('.monster-name').textContent = monster.name;
            document.querySelector('.monster-sprite').textContent = monster.sprite;
            
            // Update monster HP bar with proper number handling
            const monsterCurrentHp = Math.max(0, Math.floor(currentBattle.monsterCurrentHp));
            const monsterHpPercent = (monsterCurrentHp / monster.hp) * 100;
            document.getElementById('monsterHpBar').style.width = `${Math.max(0, Math.min(monsterHpPercent, 100))}%`;
            document.getElementById('monsterHpText').textContent = `${monsterCurrentHp}/${monster.hp}`;

            // Update player HP bar with proper number handling
            const currentHp = Math.max(0, Math.floor(stats.hp));
            const maxHp = Math.floor(totalStats.hp);
            const playerHpPercent = (currentHp / maxHp) * 100;
            document.getElementById('playerHpBar').style.width = `${Math.max(0, Math.min(playerHpPercent, 100))}%`;
            document.getElementById('playerHpText').textContent = `${currentHp}/${maxHp}`;

            // Update heal button with proper MP display
            const healBtn = document.getElementById('healBtn');
            const currentMp = Math.max(0, Math.floor(stats.mp));
            healBtn.disabled = currentMp < 10;
            healBtn.textContent = `Heal (MP: ${currentMp}/10)`;
        }

        // Perform attack
        function performAttack() {
            if (!currentBattle.active) return;

            const totalStats = calculateTotalStats();
            const baseAttack = totalStats.str - currentBattle.monster.defense;
            const randomMultiplier = 0.8 + Math.random() * 0.4; // Random between 0.8 and 1.2
            const damage = Math.max(1, Math.floor(baseAttack * randomMultiplier));
            currentBattle.monsterCurrentHp = Math.max(0, currentBattle.monsterCurrentHp - damage);

            updateBattleLog(`You dealt ${damage} damage!`);

            // Monster's turn
            if (currentBattle.monsterCurrentHp > 0) {
                const baseMonsterDamage = currentBattle.monster.attack - (totalStats.vit / 2);
                const monsterRandomMultiplier = 0.8 + Math.random() * 0.4;
                const monsterDamage = Math.max(1, Math.floor(baseMonsterDamage * monsterRandomMultiplier));
                stats.hp = Math.max(0, stats.hp - monsterDamage);
                localStorage.setItem('stats', JSON.stringify(stats));
                updateBattleLog(`${currentBattle.monster.name} dealt ${monsterDamage} damage!`);

                if (stats.hp <= 0) {
                    updateBattleUI();
                    updateStatsDisplay();
                    endBattle(false);
                    return;
                }
            } else {
                endBattle(true);
                return;
            }

            updateBattleUI();
            updateStatsDisplay();
        }

        // Perform heal
        function performHeal() {
            if (!currentBattle.active || stats.mp < 10) return;

            const totalStats = calculateTotalStats();
            const baseHeal = 20 + totalStats.mag;
            const randomMultiplier = 0.8 + Math.random() * 0.4;
            const healAmount = Math.floor(baseHeal * randomMultiplier);
            
            stats.hp = Math.min(totalStats.hp, stats.hp + healAmount);
            stats.mp = Math.max(0, stats.mp - 10);
            localStorage.setItem('stats', JSON.stringify(stats));

            updateBattleLog(`You healed for ${healAmount} HP! (-10 MP)`);
            
            // Monster's turn
            const baseMonsterDamage = currentBattle.monster.attack - (totalStats.vit / 2);
            const monsterRandomMultiplier = 0.8 + Math.random() * 0.4;
            const monsterDamage = Math.max(1, Math.floor(baseMonsterDamage * monsterRandomMultiplier));
            stats.hp = Math.max(0, stats.hp - monsterDamage);
            localStorage.setItem('stats', JSON.stringify(stats));
            updateBattleLog(`${currentBattle.monster.name} dealt ${monsterDamage} damage!`);

            if (stats.hp <= 0) {
                updateBattleUI();
                updateStatsDisplay();
                endBattle(false);
                return;
            }

            updateBattleUI();
            updateStatsDisplay();
        }

        // Update battle log
        function updateBattleLog(message) {
            const log = document.querySelector('.battle-log');
            log.innerHTML += `<div>${message}</div>`;
            log.scrollTop = log.scrollHeight;
        }

        // End battle
        function endBattle(victory) {
            const totalStats = calculateTotalStats();
            
            if (victory) {
                updateBattleLog(`You defeated ${currentBattle.monster.name}!`);
                badges.push(currentBattle.monster.id);
                localStorage.setItem('badges', JSON.stringify(badges));
                
                // Add experience
                Object.entries(statExp).forEach(([stat, exp]) => {
                    addStatExp(stat, currentBattle.monster.expReward);
                });

                // Refresh HP and MP to max
                stats.hp = totalStats.hp;
                stats.mp = totalStats.mp;
                localStorage.setItem('stats', JSON.stringify(stats));

                // Show badge notification
                const notification = document.getElementById('rewardNotification');
                notification.textContent = `🎉 You earned the ${currentBattle.monster.badgeName}!`;
                notification.classList.add('show');
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 3000);
            } else {
                updateBattleLog("You were defeated! Try again when you're stronger.");
                // Reset HP to 50% on defeat
                stats.hp = Math.floor(totalStats.hp * 0.5);
                stats.mp = Math.floor(totalStats.mp * 0.5);
                localStorage.setItem('stats', JSON.stringify(stats));
            }

            currentBattle.active = false;
            updateBadges();
            updateStatsDisplay();
            updateBattleUI();
            setTimeout(() => {
                initializeBattle();
            }, 1500);
        }

        // Update badges display
        function updateBadges() {
            const badgesContainer = document.getElementById('badges');
            badgesContainer.innerHTML = '';

            monsters.forEach(monster => {
                const badge = document.createElement('div');
                badge.className = `badge${badges.includes(monster.id) ? '' : ' locked'}`;
                badge.innerHTML = monster.badge;
                badge.setAttribute('data-name', monster.badgeName);
                badgesContainer.appendChild(badge);
            });
        }
    </script>
</body>
</html>

